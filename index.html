<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KI Progress Tracker</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4CAF50; --secondary: #fff; --background: #f5f7fa;
      --card-bg: #fff; --text: #333; --muted: #777;
      --radius: 12px; --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Inter', sans-serif;
      background: var(--background); color: var(--text);
    }
    .container { max-width:480px; margin:0 auto; padding:1rem; }
    header { text-align:center; margin-bottom:1rem; }
    header h1 { font-size:1.6rem; margin-bottom:.5rem; }
    .stats { display:flex; gap:.5rem; margin-bottom:1rem; }
    .card {
      flex:1; background:var(--card-bg); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:.75rem; text-align:center;
      position:relative; cursor:pointer;
    }
    .card .value { font-size:1.2rem; font-weight:600; }
    .card .label { color:var(--muted); font-size:.85rem; }
    .controls { display:flex; gap:.5rem; justify-content:center; margin-bottom:1rem; }
    button {
      background:var(--primary); color:var(--secondary); border:none;
      border-radius:var(--radius); padding:.6rem 1rem; font-weight:600;
      box-shadow:var(--shadow); cursor:pointer; transition:background .3s;
    }
    button:disabled { opacity:.5; cursor:default; }
    button:hover:not(:disabled) { background:#43a047; }
    #calendar {
      display:grid; grid-template-columns:repeat(7,1fr);
      gap:4px; margin-bottom:1rem;
    }
    .day {
      background:var(--card-bg); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:.5rem; text-align:center;
      cursor:pointer;
    }
    .day.past.missed { background:#fdecea; }
    .day.past.done   { background:#e8f5e9; }
    #taskSection {
      display:none; background:var(--card-bg);
      padding:1rem; border-radius:var(--radius);
      box-shadow:var(--shadow); margin-top:1rem;
    }
    #taskForm input, #taskForm button {
      width:100%; margin-bottom:.5rem; font-family:'Inter',sans-serif;
    }
    .task-item {
      display:flex; align-items:center; justify-content:space-between;
      padding:.5rem; background:var(--background);
      border-radius:var(--radius); margin-bottom:.4rem;
    }
    .task-item span { flex:1; margin-left:.5rem; }
    /* Level-Detail-Overlay */
    #levelDetails {
      display:none; background:rgba(0,0,0,0.5);
      position:fixed; top:0; left:0; right:0; bottom:0;
      align-items:center; justify-content:center;
    }
    #levelDetails .box {
      background:var(--card-bg); padding:1rem; border-radius:var(--radius);
      max-width:320px; width:90%;
    }
    #levelDetails ul { list-style:none; padding:0; }
    #levelDetails li { margin:4px 0; }
    #levelDetails progress { width:100%; height:1rem; }
  </style>

  <!-- GIS & Calendar API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>KI Progress Tracker</h1>
      <div class="stats">
        <!-- Tägliche XP -->
        <div class="card" id="xpCard">
          <div class="value" id="xpValue">0/0 XP</div>
          <div class="label">Heute</div>
        </div>
        <!-- Monats-Fortschritt bleibt /6 -->
        <div class="card">
          <div class="value" id="monthProgress">-- / 6</div>
          <div class="label">Monat</div>
        </div>
        <!-- Level -->
        <div class="card" id="levelCard">
          <div class="value" id="levelDisplay">Anfänger</div>
          <div class="label">Level</div>
        </div>
      </div>
    </header>

    <div class="controls">
      <button id="authorize_button" disabled>Kalender verbinden</button>
      <button id="signout_button" style="display:none">Abmelden</button>
    </div>

    <div id="calendar"></div>

    <div id="taskSection">
      <button id="backBtn">Zurück zur Übersicht</button><br>
      <textarea id="tasksInput" placeholder="Quests hier (je 1 Zeile, z.B. Beschreibung (50 XP))"></textarea><br>
      <button id="importTasksBtn">Quests importieren</button>
      <div id="tasksList"></div>
    </div>
  </div>

  <!-- Overlay für Level-Details -->
  <div id="levelDetails">
    <div class="box">
      <h2>Level-Fortschritt</h2>
      <progress id="levelProgress" max="5000" value="0"></progress>
      <ul id="levelList"></ul>
      <button onclick="toggleLevelDetails()">Schließen</button>
    </div>
  </div>

  <script>
    // ===== Grundsetup: Passwort & Startdatum =====
    if (!localStorage.getItem('pwVerified')) {
      const pw = prompt('Passwort eingeben:');
      if (pw !== '2610') { alert('Falsches Passwort'); throw ''; }
      localStorage.setItem('pwVerified','true');
    }
    if (!localStorage.getItem('startDate'))
      localStorage.setItem('startDate', new Date().toISOString());
    const startDate = new Date(localStorage.getItem('startDate'));
    const now       = new Date();

    // ===== Datenstrukturen aus LocalStorage =====
    const records   = JSON.parse(localStorage.getItem('records')   || '{}');
    const tasks     = JSON.parse(localStorage.getItem('tasks')     || '{}');
    const tasksDone = JSON.parse(localStorage.getItem('tasksDone') || '{}');

    // ===== DOM-Elemente =====
    const xpValue         = document.getElementById('xpValue');
    const xpCard          = document.getElementById('xpCard');
    const monthProgress   = document.getElementById('monthProgress');
    const levelCard       = document.getElementById('levelCard');
    const levelDisplay    = document.getElementById('levelDisplay');
    const levelDetails    = document.getElementById('levelDetails');
    const levelProgressEl = document.getElementById('levelProgress');
    const levelList       = document.getElementById('levelList');

    // ===== Level-Definition =====
    const levelNames = [
      'Anfänger',
      'Amateur',
      'Fortgeschrittener',
      'Profi',
      'Second AI Product Owner',
      'AI Product Owner'
    ];
    const xpPerLevel = 1000;      // je Level-Übergang
    const maxLevelXP = xpPerLevel * (levelNames.length - 1); //5000

    // ===== Header-Funktion: XP & Level anzeigen =====
    function updateHeader() {
      // 1) Tägliche XP
      const todayStr = now.toISOString().slice(0,10);
      const todaysTasks = tasks[todayStr] || [];
      const possibleXP = todaysTasks.reduce((sum,t)=>sum+t.xp,0);
      const earnedXP   = todaysTasks.reduce((sum,t,i)=> sum + ((tasksDone[todayStr]?.[i])? t.xp : 0),0);
      xpValue.textContent = `${earnedXP}/${possibleXP} XP`;

      // 2) Monatsfortschritt (unverändert)
      const diffDays = Math.floor((now - startDate)/(1000*60*60*24));
      const currentMonth = Math.min(6, Math.floor(diffDays/30)+1);
      monthProgress.textContent = `${currentMonth} / 6`;

      // 3) Cumulatives XP & Level
      let totalXP = 0;
      Object.keys(tasks).forEach(date=>{
        tasks[date].forEach((t,i)=>{
          if (tasksDone[date]?.[i]) totalXP += t.xp;
        });
      });
      const levelIndex = Math.min(levelNames.length-1, Math.floor(totalXP/xpPerLevel));
      levelDisplay.textContent = levelNames[levelIndex];

      // 4) Fülle Level-Details (Progress + Liste)
      levelProgressEl.max   = maxLevelXP;
      levelProgressEl.value = totalXP;
      levelList.innerHTML = levelNames.map((name,i)=>{
        const threshold = i*xpPerLevel;
        return `<li>${name}: ab ${threshold} XP</li>`;
      }).join('');
    }

    // Klick auf Level card zeigt Details
    function toggleLevelDetails(){
      levelDetails.style.display = levelDetails.style.display==='flex' ? 'none' : 'flex';
    }
    levelCard.onclick = toggleLevelDetails;

    // ===== Kalender & Tasks (unverändert) =====
    const calendarEl  = document.getElementById('calendar');
    const taskSection = document.getElementById('taskSection');
    const backBtn     = document.getElementById('backBtn');
    const importBtn   = document.getElementById('importTasksBtn');
    const tasksInput  = document.getElementById('tasksInput');

    function renderCalendar() {
      calendarEl.innerHTML='';
      const daysInMonth = new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
      for(let d=1;d<=daysInMonth;d++){
        const day     = new Date(now.getFullYear(),now.getMonth(),d);
        const ds      = day.toISOString().slice(0,10);
        const div     = document.createElement('div');
        div.className = 'day';
        div.textContent = d;
        if(day < new Date().setHours(0,0,0,0)){
          div.classList.add('past');
          div.classList.add(records[ds] ? 'done' : 'missed');
        }
        div.onclick  = ()=> openTasks(ds);
        div.ondblclick = ()=>{
          if(day < new Date().setHours(0,0,0,0)){
            records[ds] = !records[ds];
            localStorage.setItem('records',JSON.stringify(records));
            renderCalendar();
            updateHeader();
          }
        };
        calendarEl.appendChild(div);
      }
    }

    function openTasks(dateStr){
      selectedDate = dateStr;
      calendarEl.style.display = 'none';
      document.querySelector('.controls').style.display = 'none';
      taskSection.style.display = 'block';
      renderTasks();
    }
    backBtn.onclick = ()=>{
      calendarEl.style.display = 'grid';
      document.querySelector('.controls').style.display = 'flex';
      taskSection.style.display = 'none';
    };

    function importTasks(){
      const lines = tasksInput.value.split('\n').map(l=>l.trim()).filter(l=>l);
      if(!lines.length) return;
      const todayStr = now.toISOString().slice(0,10);
      tasks[todayStr] = lines.map(l=>{
        // parse xp in "(xx XP)"
        const m = l.match(/\((\d+)\s*XP\)$/i);
        const xp = m? parseInt(m[1],10) : 0;
        const desc = m? l.slice(0,m.index).trim() : l;
        return {desc,time:'',xp};
      });
      localStorage.setItem('tasks',JSON.stringify(tasks));
      records[todayStr] = false;
      localStorage.setItem('records',JSON.stringify(records));
      renderTasks();
      renderCalendar();
      updateHeader();
    }
    importBtn.onclick = importTasks;

    function renderTasks(){
      const list = tasks[selectedDate]||[];
      const container = document.getElementById('tasksList');
      container.innerHTML='';
      list.forEach((t,i)=>{
        const div = document.createElement('div');
        div.className = 'task-item';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = tasksDone[selectedDate]?.[i] || false;
        chk.onchange = ()=>{
          tasksDone[selectedDate] = tasksDone[selectedDate]||[];
          tasksDone[selectedDate][i] = chk.checked;
          localStorage.setItem('tasksDone',JSON.stringify(tasksDone));
          if(tasksDone[selectedDate].filter(Boolean).length === list.length){
            records[selectedDate]=true;
            localStorage.setItem('records',JSON.stringify(records));
            renderCalendar();
          }
          updateHeader();
        };
        const span = document.createElement('span');
        span.textContent = `${t.desc} (${t.xp} XP)`;
        div.append(chk,span);
        container.appendChild(div);
      });
    }

    // ===== Google OAuth & Calendar =====
    const CLIENT_ID = '828803560489-o5hh7nlg16oek9v7d1a5l4upd038l0gq.apps.googleusercontent.com';
    const API_KEY   = 'AIzaSyBRZDlKOcizdAV9NSSPweyBCV1_ce0uv1I';
    const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
    const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton   = document.getElementById('signout_button');
    let tokenClient;

    function handleClientLoad(){
      gapi.load('client', initGapiClient);
    }
    function initGapiClient(){
      gapi.client.init({apiKey:API_KEY,discoveryDocs:DISCOVERY_DOCS})
        .then(()=>{
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id:CLIENT_ID, scope:SCOPES,
            callback:(resp)=> {
              if(resp.error) console.error(resp);
              else updateSigninStatus(true);
            }
          });
          authorizeButton.disabled = false;
          authorizeButton.onclick = ()=>tokenClient.requestAccessToken({prompt:'consent'});
          signoutButton.onclick   = ()=>{
            const token = gapi.client.getToken()?.access_token;
            if(token) google.accounts.oauth2.revoke(token);
            gapi.client.setToken('');
            updateSigninStatus(false);
          };
        });
      updateHeader();
    }
    function updateSigninStatus(signedIn){
      authorizeButton.style.display = signedIn ? 'none':'inline-block';
      signoutButton.style.display   = signedIn ? 'inline-block':'none';
    }
    window.onload = handleClientLoad;

    // erster Aufruf
    renderCalendar();
    updateHeader();
  </script>
</body>
</html>
